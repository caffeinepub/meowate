{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Force TURN-only ICE for matchmaking voice calls",
  "requirements": [
    {
      "id": "REQ-1",
      "summary": "Enforce TURN-only (relay-only) ICE behavior for matchmaking WebRTC voice calls to reduce \"failed to match\" errors on restrictive networks.",
      "acceptanceCriteria": [
        "In frontend/src/hooks/useWebRTC.ts, RTCPeerConnection is created with an RTCConfiguration that enforces TURN-only behavior (e.g., iceTransportPolicy set to \"relay\").",
        "When attempting a match on restrictive networks (e.g., double NAT), ICE candidates generated/sent are relay candidates, and the diagnostics field usingTurnServer becomes true during the connection attempt.",
        "No regression: matching flow still transitions out of \"connecting\" via the existing timeout/error handling if the relay connection cannot be established."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useWebRTC.ts",
          "operation": "modify",
          "description": "Update the WebRTC RTCConfiguration used to construct RTCPeerConnection to TURN-only by setting iceTransportPolicy to \"relay\" (and adjusting ICE server list/behavior as needed so only relay candidates are used/sent). Ensure diagnostics.usingTurnServer is reliably set true during connection attempts when relay candidates are gathered/used, and keep existing timeout/retry/cleanup behavior intact to avoid regressions."
        },
        {
          "path": "frontend/src/pages/MatchingPage.tsx",
          "operation": "modify",
          "description": "Verify the diagnostics UI surfaces TURN usage clearly during connection attempts (using connection.diagnostics.usingTurnServer). If not currently shown, add a read-only diagnostics row so testers can confirm TURN-only behavior without needing console logs; do not change the existing matching state machine or timeout/error handling."
        }
      ]
    }
  ]
}